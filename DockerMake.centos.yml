# vim: sts=2 ts=2 sw=2 ft=yaml

# RHEL family

# LAYERS
base:
  ignore: |
    *.pyc
    *~
    *.tmp
  build: |
    MAINTAINER Petr Michalec "<epcim@apealive.net>"
    ENV LC_ALL C
    ENV LANG C.UTF-8
    ENV LANGUAGE $LANG
    ENV TZ Etc/UTC
    ENV LAYER_PKGUPDT "yum update -y"
    ENV LAYER_INSTALL "yum install -y"
    ENV LAYER_CLEANUP "yum clean all && rm -rf /tmp/* /var/tmp/* /root/.cache /home/*/.cache"



common-cleanup:
  build: |
    RUN echo "Layer common cleanup" \
      && eval ${LAYER_CLEANUP}


common:
  build: |
    RUN echo "Layer with common packages" \
      && eval ${LAYER_PKGUPDT} \
      && yum upgrade -y \
      && ${LAYER_INSTALL} \
           curl \
           git \
           sudo \
           vim-tiny \
           wget \
            \
           ca-certificates \
           netcat \
           tzdata \
           gnupg2 \
           zlib1g-dev \
      && eval ${LAYER_CLEANUP}


salt:
  build: |
    ARG SALT_VERSION="stable"
    ENV SALT_BOOTSTRAP_OPTS "-dX ${SALT_VERSION}"
    RUN echo "Layer salt" \
      && eval ${LAYER_PKGUPDT} \
      && mkdir -p /var/run/salt /var/cache/salt /var/log/salt /etc/salt/pki/master/minions \
      && curl -qL https://bootstrap.saltstack.com | $SUDO sh -s -- -M ${SALT_BOOTSTRAP_OPTS} \
      && useradd --system salt \
      && chown -R salt:salt /etc/salt /var/cache/salt /var/log/salt /var/run/salt \
      && eval ${LAYER_CLEANUP}


wheel:
  requires:
    - base
  build: |
    ARG WHEELHOUSE_REVISION="master"
    ENV WHEELHOUSE_REVISION $WHEELHOUSE_REVISION
    # NOTE, wheelhouse requires at least ruamel v0.15.x (debian:stretch has 0.13.x as of 2018.2)
    # python-ruamel.yaml \
    RUN echo "Layer pip/ruamel.yaml prerequisites" \
      && eval ${LAYER_PKGUPDT} \
      && ${LAYER_INSTALL}  \
         python-pip \
         python-setuptools \
         libpython-dev \
         python-dev \
         gcc \
      && eval ${LAYER_CLEANUP}
    RUN echo "Layer wheelhouse" \
      && git clone https://github.com/epcim/wheelhouse.git /wh \
      && cd /wh && git checkout origin/$WHEELHOUSE_REVISION \
      && LANG=C LC_ALL=C pip install -r /wh/requirements.txt


# BASE IMAGES
centos-7:
  FROM: centos:7
  requires:
    - base
    - common

